The English version of this document is [here](https://github.com/RaevskyDN/aij2020-amur-noflood-public/main/README.en.md)

# Модель для прогнозирования уровня воды на реке Амур (AIJ-2020)
<p align="center">
  <img src="pics/NN - прогноз на 5 лет.png" width="100%">
</p>

Репозиторий включает в себя:
* EDA.ipynb - ноутбук с илсследованием и комментариями
* amurlevel_model - модуль с логически разделенными подмодулями 
* predict.py - скрипт для прогнозирования уровня воды вперед на 10 суток
* train.py - скрипт для обучения модели по прогнозированию уровня воды вперед на 10 суток
* Dockerfile_train - докерфайл для создания образа для обучения модели
* Dockerfile_predict - докерфайл для создания образа для инференса модели
* data - директория с необходимыми входными данными, а также дополнительными данными, необходимыми для работы модели (например, веса модели)
* data/mean_std_stats.json - статистика с mean,std по всем численным признакам (мне так удобнее, чем с обертками sklearn)
* data/weights-aij2020amurlevel-2017.h5 - веса модели, полученные при обучении на данных до 2017-12-31
* data/weights-aij2020amurlevel-2012.h5 - веса модели, полученные при обучении на данных до 2012-12-3
* abstracts.pdf - краткая презентация по используемому подходу к решению задачи

### Структура данных
Данные должны включать в себя исторические данные с гидропостов и гидростанций, данные метео в формате АИСОРИ. Данные по снежному покрову и льду (_ice.csv) или по суточному расходу воды (_disch_d.csv) не обязательны, если по какой-либо гидростанции их нет, то данные будут пропущены, при чтении будет выведено предупреждение что этого файла нет. В каждом файле должна быть история за весь период.
**ВАЖНО! Исходные должны быть в точно таком же формате, как и исходные данные от организаторов (такое же количество полей в таком же порядке), несколько примеров приложены в репозитории. Данные можно скачать [тут](https://storage.yandexcloud.net/datasouls-ods/materials/c8b9bab3/datasets.zip)**
```
data/
---hydro/
------05001_daily.csv
------05001_ice.csv
------05002_daily.csv
------...
---meteo_new/
------4443141.csv
------4483311.csv
------...
---mean_std_stats.json
---weights-aij2020amurlevel-2017.h5
---...
```

### Модели с прогнозом погоды
В текущей версии используются два сервиса, предсказывающих погоду:
<ol>
  <li> Яндекс.погода (7 дней вперед, 5000 запросов/сутки, бесплатно первые 30 дней) - https://yandex.ru/dev/weather/doc/dg/concepts/pricing.html/ </li>
  <li> Openweather (16 дней вперед, 5000 запросов/месяц, 10$/месяц) - https://rapidapi.com/community/api/open-weather-map?endpoint=53aa6042e4b051a76d241b79 </li>
</ol>

Credentials надо задать в файле конфига config.py. 

### Конфиг модели
В модуле amurlevel_model есть файл config.py с важными настройками для работы модели. Ниже описаны самые важные параметры:
* DATASETS_PATH - путь по которому будут лежать необходимые исходне данные, а так же сохраняться результаты инференса (predict.py)
* DAYS_FORECAST - количество прогнозируемых дней, сейчас задано 10. Менять можно только с переобучением модели заново
* ALL_STATIONS - все гидростанции и гидропосты, признаки с которых используются в модели и уровни которых предсказываются
* NUMBER_OF_INFERENCE_STATIONS - количество станций (первые станции из ALL_STATIONS по порядку), для которых предсказание записывается при вызове скрипта predict.py

### Инференс
Для инференса вначале надо убедиться, что в файле config.py - DATASETS_PATH='/data'
Затем нужно собрать докер образ для обучения и запустить с нужными параметрами
```
docker build . -f Dockerfile_predict -t raev_aij2020_amur_predict
docker run -v $(pwd)/data:/data raev_aij2020_amur_predict -f_day 2017-12-10 -w /data/weights-aij2020amurlevel-2017.h5
```

### Обучение
Для обучения вначале надо убедиться, что в файле config.py - DATASETS_PATH='/data'
Затем нужно собрать докер образ для обучения и запустить с нужными параметрами. Веса модели, приложенные в репозитории, получены с GPU на Kaggle. Локально (Interl Core I5-8265U, 4 cores, 8 гб RAM) тоже запускал, но обучение идет гораздо медленнее.
```
docker build . -f Dockerfile_train -t raev_aij2020_amur_train
docker run -v $(pwd)/data:/data raev_aij2020_amur_train -t_day 2017-12-01 -w /data/weights-aij2020amurlevel-2017.h5
```

### Ноутбук
Ноутбук (EDA.ipynb) содержит в себе некоторые исследования + обучение моделей и построение графиков. Чтобы его запустить нужно вначале положить все необходимые данные в data/. Если хочется обучить модель в ноутбуке, нужно в первой ячейке поставить ```TRAIN=True```

**ВАЖНО! Если обучать модель в ноутбуке локально, то зависимости могут не совпадать с теми, что в requirements.txt**. Если необходим инференс обученной модели через докер контейнер, то в первой ячейке в ноутбуке нужно вставить:
```
!pip install requirements.txt
```

### Cписок полезной литературы
При подготовке был изучен достаточно большой объем литературы, ниже приведены ссылки на самые полезные (по мнению автора) источники (ссылки приведены в свободном формате):
<ol>
<li> Спектральный анализ временных рядов в экономике [Текст] / К. Гренджер, М. Хатанака ; Пер. В. С. Дуженко, Е. Г. Угер ; Науч. ред. В. В. Налимов. - Москва : Статистика, 1972. - 312 с. : черт.; 22 см.</li>
<li> С.В. Борщ, Ю.А. Симонов, А.В. Христофоров, Н.М. Юмина. КРАТКОСРОЧНОЕ ПРОГНОЗИРОВАНИЕ УРОВНЕЙ ВОДЫ НА РЕКЕ АМУР</li>
<li> Известия Томского политехнического университета. Инжиниринг георесурсов. 2016. Т. 327. № 11. 105–115  Лариошкин В.В. Методика прогноза дождевых паводков в бассейне Верхнего Амура (на примере р. Онон)</li>
<li> Экстремальные паводки в бассейне Амура: гидрологические аспекты / Сб. работ по гидрологии / под ред. Георгиевского В.Ю., ФГБУ «ГГИ», СПБ, ООО «ЭсПэХа», 2015.- стр.171. </li>
<li> Мы и амурские наводнения: невыученный урок? / Под ред.А. В. Шаликовского. — М.: Всемирный фонд дикой природы (WWF),2016. — 216 с.</li>
<li> Калугин А.С., Модель формирования стока реки Амур и ее применение для оценки возможных изменений водного режима, дис. … канд. геогр. Наук. Институт водных проблем РАН, Москва, 2016</li>
<li> С.В. Борщ , Д.А. Бураков , Ю.А. Симонов. МЕТОДИКА ОПЕРАТИВНОГО РАСЧЕТА И ПРОГНОЗА СУТОЧНОГО ПРИТОКА ВОДЫ В ВОДОХРАНИЛИЩЕ ЗЕЙСКОЙ ГЭС </li>
<li> ЭКСТРЕМАЛЬНОЕ НАВОДНЕНИЕ В БАССЕЙНЕ АМУРА В 2013 ГОДУ: АНАЛИЗ ФОРМИРОВАНИЯ, ОЦЕНКИ И РЕКОМЕНДАЦИИ,  Болгов М.В., Алексеевский Н.И., Гарцман Б.И., Георгиевский В.Ю., Дугина И.О., Ким В.И., Махинов А.Н., Шалыгин А.Л. География и природные ресурсы. 2015. № 3. С. 17-26.</li>
 </ol>

